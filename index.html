<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complete Quiz – Mock Exam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6; /* Tailwind gray-100 */
    }
    .quiz-page, .ai-quiz-page {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    .quiz-page.active, .ai-quiz-page.active {
      display: block;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .question-block {
      margin-bottom: 1.5rem;
      padding: 1.25rem; /* p-5 */
      border: 1px solid #e5e7eb; /* Tailwind gray-200 */
      border-radius: 0.5rem; /* rounded-lg */
      background-color: white;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
        0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow-md */
    }
    .result {
      margin-top: 0.75rem; /* mt-3 */
      font-weight: 600; /* font-semibold */
      font-size: 0.875rem; /* text-sm */
    }
    .result.text-green-700 {
      color: #047857; /* Tailwind green-700 */
    }
    .result.text-red-700 {
      color: #b91c1c; /* Tailwind red-700 */
    }

    input[type='radio'] {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      width: 1.25em;
      height: 1.25em;
      border: 2px solid #6b7280; /* Tailwind gray-500 */
      border-radius: 50%;
      outline: none;
      cursor: pointer;
      margin-right: 0.5em;
      position: relative;
      top: 0.2em;
    }
    input[type='radio']:checked {
      border-color: #2563eb; /* Tailwind blue-600 */
      background-color: #2563eb; /* Tailwind blue-600 */
    }
    input[type='radio']:checked::before {
      content: '';
      display: block;
      width: 0.6em;
      height: 0.6em;
      background-color: white;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    label.flex {
      cursor: pointer;
    }

    #notificationArea {
      position: fixed;
      top: 1.25rem;
      right: 1.25rem;
      padding: 1rem;
      border-radius: 0.375rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05);
      z-index: 100;
      display: none;
      color: white;
      font-weight: 500;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
      animation: fadeInModal 0.3s ease-out;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 2rem;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 0.75rem; /* rounded-xl */
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
        0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
    }
    .modal-header {
      padding-bottom: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb; /* Tailwind gray-200 */
    }
    .modal-body {
      max-height: 60vh;
      overflow-y: auto;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    @keyframes fadeInModal {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Styles for category details in stats modal */
    .category-detail summary {
      cursor: pointer;
      padding: 0.5rem 0;
      font-weight: 600;
      color: #374151; /* Tailwind gray-700 */
      border-bottom: 1px solid #e5e7eb;
    }
    .category-detail summary:hover {
      color: #1f2937; /* Tailwind gray-900 */
    }
    .category-detail ul {
      list-style-type: disc;
      padding-left: 1.5rem;
      margin-top: 0.5rem;
    }
    .category-detail li {
      margin-bottom: 0.25rem;
      color: #4b5563; /* Tailwind gray-600 */
    }
  </style>
</head>

<body class="p-4 md:p-8">
  <div id="notificationArea"></div>

  <div class="container mx-auto max-w-3xl bg-white shadow-xl rounded-xl p-6 md:p-8">
    <header class="text-center mb-8 relative">
      <h1
        id="mainQuizTitle"
        class="text-4xl font-bold text-blue-700"
      >
        Interactive Mock Exam Quiz
      </h1>
      <p id="mainQuizSubtitle" class="text-gray-600 mt-2">
        Test your knowledge with these 100 questions.
      </p>

      <button
        id="langToggleButton"
        onclick="toggleLanguage()"
        class="absolute top-0 right-0 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md text-sm transition-colors duration-150"
      >
        Passer en Français
      </button>

      <div class="mt-6 border-t pt-4">
        <h3 class="text-lg font-semibold text-gray-700 mb-3" id="chooseModeTitle">Choose Your Mode</h3>
        <div class="flex flex-wrap justify-center gap-3">
          <button
            id="testModeButton"
            onclick="switchMode('test')"
            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-150"
          >
            Test Mode
          </button>
          <button
            id="learningModeButton"
            onclick="switchMode('learn')"
            class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-150"
          >
            Learning Mode
          </button>
          <button
            id="aiModeButton"
            onclick="switchMode('ai')"
            class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            AI Generated Quiz
          </button>
        </div>
      </div>

      <div id="shuffleControls" class="mt-4 flex items-center justify-center space-x-2">
        <label class="flex items-center space-x-2">
          <input type="checkbox" id="shuffleToggle" checked />
          <span id="shuffleLabel" class="text-gray-700">Default order</span>
        </label>
        <button
          id="shuffleButton"
          class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Shuffle Questions
        </button>
      </div>
    </header>

    <div id="testModeContainer" style="display: none;">
      <!-- Progress Bar for Test Mode -->
      <div class="w-full bg-gray-200 rounded-full h-4 mb-4 relative">
        <div id="testProgressBar" class="bg-blue-600 h-4 rounded-full" style="width: 0%;"></div>
        <span id="testProgressText" class="absolute inset-0 flex justify-center items-center text-white font-semibold text-xs">0% Complete</span>
      </div>

      <div id="page-0" class="quiz-page active">
        <h2
          id="pageTitle-0"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 1 – 10
        </h2>
      </div>
      <div id="page-1" class="quiz-page">
        <h2
          id="pageTitle-1"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 11 – 20
        </h2>
      </div>
      <div id="page-2" class="quiz-page">
        <h2
          id="pageTitle-2"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 21 – 30
        </h2>
      </div>
      <div id="page-3" class="quiz-page">
        <h2
          id="pageTitle-3"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 31 – 40
        </h2>
      </div>
      <div id="page-4" class="quiz-page">
        <h2
          id="pageTitle-4"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 41 – 50
        </h2>
      </div>
      <div id="page-5" class="quiz-page">
        <h2
          id="pageTitle-5"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 51 – 60
        </h2>
      </div>
      <div id="page-6" class="quiz-page">
        <h2
          id="pageTitle-6"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 61 – 70
        </h2>
      </div>
      <div id="page-7" class="quiz-page">
        <h2
          id="pageTitle-7"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 71 – 80
        </h2>
      </div>
      <div id="page-8" class="quiz-page">
        <h2
          id="pageTitle-8"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 81 – 90
        </h2>
      </div>
      <div id="page-9" class="quiz-page">
        <h2
          id="pageTitle-9"
          class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2"
        >
          Questions 91 – 100
        </h2>
      </div>

      <footer class="mt-10 pt-6 border-t border-gray-300">
        <div class="navigation-controls flex justify-between items-center mb-4">
          <button
            id="prevButton"
            onclick="navigatePage(-1)"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"
          >
            Previous
          </button>
          <span id="pageIndicator" class="text-gray-700 font-medium text-lg"
            >Page 1 / 10</span
          >
          <button
            id="nextButton"
            onclick="navigatePage(1)"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"
          >
            Next
          </button>
        </div>
        <div class="mt-6 space-y-3 md:space-y-0 md:flex md:space-x-3">
          <button
            id="viewResultsButton"
            onclick="showFinalResultsModal('test')"
            class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg w-full md:w-auto shadow-md transition-colors duration-150"
          >
            View Final Results
          </button>
          <button
            id="resetAllButton"
            onclick="resetAllAnswers()"
            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg w-full md:w-auto shadow-md transition-colors duration-150"
          >
            Reset All Answers
          </button>
        </div>
      </footer>
    </div>

    <div id="learningModeContainer" style="display: none;">
      <div class="mt-8 pt-6 border-t border-gray-300">
        <h3 id="learningToolsTitle" class="text-2xl font-semibold mb-4 text-center text-gray-700">Learning Tools</h3>
        <div class="flex flex-col md:flex-row items-center justify-center space-y-3 md:space-y-0 md:space-x-4 mb-6">
          <div class="flex items-center space-x-2">
            <label for="quizStrategy" class="text-gray-700 font-medium">Generate:</label>
            <select id="quizStrategy" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
              <option value="default">Default (Mixed Questions)</option>
              <option value="unseen">Unseen Questions</option>
              <option value="problematic">Problematic Questions</option>
              <option value="random_x">Random X Questions</option>
            </select>
          </div>
          <div id="numQuestionsInputContainer" class="flex items-center space-x-2" style="display: none;">
            <label for="numQuestions" class="text-gray-700 font-medium">Number:</label>
            <input type="number" id="numQuestions" min="1" max="100" value="10" class="w-20 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
          </div>
          <button
            id="generatePracticeCardButton"
            onclick="generatePracticeCardFromUI()"
            class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg w-full md:w-auto shadow-md transition-colors duration-150"
          >
            Generate Card
          </button>
        </div>
        <div class="space-y-3 md:space-y-0 md:flex md:space-x-3 md:justify-center">
          <button
            id="viewStatsButton"
            onclick="showPerformanceStatsModal()"
            class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg w-full md:w-auto shadow-md transition-colors duration-150"
          >
            View Performance Stats
          </button>
        </div>
      </div>

      <div id="practiceQuestionsDisplayArea" class="mt-8">
        <!-- Practice card progress indicator -->
        <p id="practiceCardProgress" class="text-center text-gray-600 font-medium mb-4"></p>
        </div>

      <div class="mt-6 text-center space-y-3">
          <button
            id="checkPracticeCardButton"
            onclick="checkPracticeCardAnswers()"
            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md"
            style="display: none;"
          >
            Check Card Answers
          </button>
          <p id="practiceCardScoreText" class="text-lg font-semibold text-gray-800"></p>
          <button
            id="generateNewPracticeCardButton"
            onclick="generatePracticeCardFromUI()"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md mt-4"
            style="display: none;"
          >
            Generate New Card
          </button>
      </div>
    </div>
    
    <div id="aiModeContainer" style="display: none;">
        <!-- Content for AI Mode will be dynamically generated here -->
    </div>

  </div>

  <div id="finalResultsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close-button" onclick="closeFinalResultsModal()">&times;</span>
        <h2 id="finalResultsTitle" class="text-2xl font-bold text-gray-800">
          Final Results
        </h2>
      </div>
      <div id="finalResultsBody" class="modal-body space-y-3">
        </div>
      <div class="mt-6 text-center">
        <p id="overallScoreText" class="text-xl font-bold text-blue-700"></p>
      </div>
    </div>
  </div>

  <div id="performanceStatsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close-button" onclick="closePerformanceStatsModal()">×</span>
        <h2 id="performanceStatsTitle" class="text-2xl font-bold text-gray-800">Performance Statistics</h2>
      </div>
      <div id="performanceStatsBody" class="modal-body space-y-2">
        <!-- Achievements will be displayed here -->
        <h3 id="achievementsTitle" class="text-xl font-semibold mb-2 text-gray-700">Achievements</h3>
        <div id="achievementsDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Badges will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>

  <div id="customConfirmationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close-button" onclick="closeConfirmationModal()">&times;</span>
        <h2 class="text-2xl font-bold text-gray-800">Confirmation</h2>
      </div>
      <div id="confirmationModalBody" class="modal-body">
        <p class="text-gray-700"></p>
      </div>
      <div class="mt-6 text-center space-x-4">
        <button id="confirmYes" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Yes</button>
        <button id="confirmNo" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md">No</button>
      </div>
    </div>
  </div>

  <script src="./quizQuestions.js"></script>
  <!-- 
    NOTE: Create a file named "Questions_AI.js" in the same directory.
    It should contain an array of question objects like the example below.
    Start qNum from 101 to avoid conflicts with the main quiz.

    Expected format for Questions_AI.js:
    const allAiQuizData = [
      { qNum: 101, text: { en: 'This is an AI question in English.', fr: 'Ceci est une question IA en français.' }, answer: "true" },
      { qNum: 102, text: { en: 'This is another AI question.', fr: 'Ceci est une autre question IA.' }, answer: "false" }
    ];
  -->
  <script src="./Questions_AI.js"></script>
  <script>
    // ––– Language and UI Strings –––
    let currentLanguage = 'en'; // Default language set to English
    const uiStrings = {
      fr: {
        pageTitleDoc: 'Quiz Complet – Examen Blanc',
        mainQuizTitle: 'Examen Blanc Quiz Interactif',
        mainQuizSubtitle: 'Testez vos connaissances avec ces 100 questions.',
        langToggleButton: 'Switch to English',
        trueLabel: 'Vrai',
        falseLabel: 'Faux',
        correctFeedback: 'Correct !',
        incorrectFeedbackPrefix: 'Faux ! La bonne réponse était ',
        selectAnswerPrompt: 'Veuillez sélectionner une réponse.',
        checkAnswersButton: 'Vérifier les réponses',
        pageIndicatorPrefix: 'Page',
        prevButton: 'Précédent',
        nextButton: 'Suivant',
        resetButton: 'Réinitialiser toutes les réponses',
        viewResultsButton: 'Voir les résultats finaux',
        finalResultsTitle: 'Résultats Finaux',
        overallScoreLabel: 'Score Total',
        scoreForPageLabel: 'Score pour cette page',
        allAnswersResetMsg: 'Toutes les réponses ont été réinitialisées.',
        questionsLabel: 'Questions',
        noResultsYet:
          'Aucun résultat à afficher. Veuillez compléter des pages du quiz.',
        defaultLabel: 'Ordre par défaut',
        shuffleButton: 'Mélanger les questions',
        learningToolsTitle: "Outils d'Apprentissage",
        generatePracticeCardButton: "Générer une Carte de Pratique (10 Q)",
        viewStatsButton: "Voir les Statistiques de Performance",
        practiceCardTitle: "Carte de Pratique",
        checkPracticeCardButton: "Vérifier la Carte",
        performanceStatsTitle: "Statistiques de Performance",
        categoryUnseen: "Non vues",
        categoryNewLearning: "Nouvelles en apprentissage",
        categoryLearning: "En apprentissage",
        categoryMastered: "Maîtrisées",
        categoryProblematic: "Problématiques",
        questionsInCategory: "questions dans cette catégorie",
        totalCorrect: "Total Correct",
        totalIncorrect: "Total Incorrect",
        performanceDataReset: "Données de performance réinitialisées.",
        confirmResetPerformance: "Êtes-vous sûr de vouloir réinitialiser toutes les données de performance des questions ? Cette action est irréversible.",
        testModeButton: "Mode Examen",
        learningModeButton: "Mode Apprentissage",
        generateNewPracticeCardButton: "Générer une Nouvelle Carte",
        noQuestionsAvailableForPractice: "Pas assez de questions disponibles pour générer une carte de pratique. Essayez de répondre à plus de questions en mode examen ou réinitialisez vos données.",
        generateLabel: "Générer:",
        numQuestionsLabel: "Nombre:",
        optionDefault: "Par défaut (Questions Mixtes)",
        optionUnseen: "Questions Non Vues",
        optionProblematic: "Questions Problématiques",
        optionRandomX: "X Questions Aléatoires",
        invalidNumQuestions: "Veuillez entrer un nombre valide de questions (1-100).",
        // Gamification strings
        testProgress: "Progrès du Test",
        percentComplete: "% Terminé",
        streakNotification: "Série de {count} réponses correctes !",
        perfectCardNotification: "Carte de pratique parfaite ! ({count} consécutives)",
        goodJob90Percent: "90% - Excellent travail !",
        achievementUnlocked: "Débloqué : {name} !",
        achievementsTitle: "Réalisations",
        noQuestionsInCategory: "Aucune question dans cette catégorie.",
        practiceCardProgress: "Question {current} / {total}",
        encouragementCorrect: [
            "Fantastique !", "Impressionnant !", "Bien joué !", "Exact !", "Parfait !",
            "Continuez comme ça !", "Superbe !", "Très bien !"
        ],
        encouragementIncorrect: [
            "Gardez la tête haute !", "Ne vous inquiétez pas, vous y arriverez !", "Chaque erreur est une leçon.",
            "Continuez d'essayer !", "Prochaine fois sera la bonne !", "C'est un processus d'apprentissage."
        ],
        // New AI Mode strings
        aiModeButton: 'Quiz Généré par IA',
        aiQuizTitle: 'Quiz Généré par IA',
        aiQuizProgress: "Progression du Quiz IA",
        resetAiQuizButton: 'Réinitialiser le Quiz IA',
        confirmResetAiQuiz: "Êtes-vous sûr de vouloir réinitialiser toutes les réponses du quiz IA ? Cette action est irréversible.",
        aiQuizResetMsg: "Le quiz IA a été réinitialisé.",
        chooseModeTitle: "Choisissez Votre Mode",
        aiResultsTitle: "Résultats du Quiz IA",
      },
      en: {
        pageTitleDoc: 'Complete Quiz – Mock Exam',
        mainQuizTitle: 'Interactive Mock Exam Quiz',
        mainQuizSubtitle: 'Test your knowledge with these 100 questions.',
        langToggleButton: 'Passer en Français',
        trueLabel: 'True',
        falseLabel: 'False',
        correctFeedback: 'Correct!',
        incorrectFeedbackPrefix: 'Wrong! The correct answer was ',
        selectAnswerPrompt: 'Please select an answer.',
        checkAnswersButton: 'Check Answers',
        pageIndicatorPrefix: 'Page',
        prevButton: 'Previous',
        nextButton: 'Next',
        resetButton: 'Reset All Answers',
        viewResultsButton: 'View Final Results',
        finalResultsTitle: 'Final Results',
        overallScoreLabel: 'Total Score',
        scoreForPageLabel: 'Score for this page',
        allAnswersResetMsg: 'All answers have been reset.',
        questionsLabel: 'Questions',
        noResultsYet: 'No results to display yet. Please complete some quiz pages.',
        defaultLabel: 'Default order',
        shuffleButton: 'Shuffle Questions',
        learningToolsTitle: "Learning Tools",
        generatePracticeCardButton: "Generate Practice Card (10 Q)",
        viewStatsButton: "View Performance Stats",
        practiceCardTitle: "Practice Card",
        checkPracticeCardButton: "Check Card Answers",
        performanceStatsTitle: "Performance Statistics",
        categoryUnseen: "Unseen",
        categoryNewLearning: "New Learning",
        categoryLearning: "Learning",
        categoryMastered: "Mastered",
        categoryProblematic: "Problematic",
        questionsInCategory: "questions in this category",
        totalCorrect: "Total Correct",
        totalIncorrect: "Total Incorrect",
        performanceDataReset: "Performance data has been reset.",
        confirmResetPerformance: "Are you sure you want to reset all question performance data? This action cannot be undone.",
        testModeButton: "Test Mode",
        learningModeButton: "Learning Mode",
        generateNewPracticeCardButton: "Generate New Card",
        noQuestionsAvailableForPractice: "Not enough questions available to generate a practice card. Try answering more questions in test mode or reset your data.",
        generateLabel: "Generate:",
        numQuestionsLabel: "Number:",
        optionDefault: "Default (Mixed Questions)",
        optionUnseen: "Unseen Questions",
        optionProblematic: "Problematic Questions",
        optionRandomX: "Random X Questions",
        invalidNumQuestions: "Please enter a valid number of questions (1-100).",
        testProgress: "Test Progress",
        percentComplete: "% Complete",
        streakNotification: "{count}-Question Streak!",
        perfectCardNotification: "Perfect Practice Card! ({count} consecutive)",
        goodJob90Percent: "90% - Good job!",
        achievementUnlocked: "Achievement Unlocked: {name}!",
        achievementsTitle: "Achievements",
        noQuestionsInCategory: "No questions in this category.",
        practiceCardProgress: "Question {current} / {total}",
        encouragementCorrect: [ "Fantastic!", "Impressive!", "Well done!", "Exactly!", "Perfect!", "Keep it up!", "Superb!", "Very good!" ],
        encouragementIncorrect: [ "Keep your chin up!", "Don't worry, you'll get it!", "Every mistake is a lesson.", "Keep trying!", "Next time will be the one!", "It's a learning process." ],
        // New AI Mode strings
        aiModeButton: 'AI Generated Quiz',
        aiQuizTitle: 'AI Generated Quiz',
        aiQuizProgress: "AI Quiz Progress",
        resetAiQuizButton: 'Reset AI Quiz',
        confirmResetAiQuiz: "Are you sure you want to reset all AI quiz answers? This action cannot be undone.",
        aiQuizResetMsg: "The AI quiz has been reset.",
        chooseModeTitle: "Choose Your Mode",
        aiResultsTitle: "AI Quiz Results",
      }
    };

    // The allQuizData array is now loaded from quizQuestions.js
    // It is globally available because quizQuestions.js is loaded before this script.
    
    // AI quiz data is loaded from Questions_AI.js
    const allAiQuizData = typeof allAiQuizData !== 'undefined' ? allAiQuizData : [];


    // ––– Global Variables & Constants –––
    let quizOrder = Array.from({ length: allQuizData.length }, (_, i) => i);
    const originalOrder = Array.from(quizOrder);
    let currentPageIndex = 0;
    const questionsPerPage = 10;
    const numPages = Math.ceil(allQuizData.length / questionsPerPage);
    const pageElements = [];
    let pageScores = Array(numPages).fill(null).map(() => ({ score: 0, totalQuestions: 0, attempted: false }));
    let savedSelectedAnswers = {};
    
    // AI Mode State
    let aiCurrentPageIndex = 0;
    let numAiPages = 0;
    const aiPageElements = [];
    let aiPageScores = [];
    let aiSavedSelectedAnswers = {};

    let performanceData = {};
    let currentPracticeCardQuestions = [];
    let currentPracticeCardQuestionIndex = 0;
    const DEFAULT_PRACTICE_CARD_SIZE = 10;
    let currentMode = 'learn';
    let quizCounter = 0;
    let currentLearningStreak = 0;
    let consecutivePerfectCards = 0;
    const achievements = [
        { id: 'first_step', name_fr: 'Premier Pas', name_en: 'First Step', description_fr: 'Terminez votre première page en mode Examen.', description_en: 'Complete your first page in Test Mode.', check: () => pageScores.some(score => score && score.attempted) },
        { id: 'master_learner_i', name_fr: 'Apprenti Maître I', name_en: 'Master Learner I', description_fr: 'Maîtrisez 5 questions (catégorie "Maîtrisées").', description_en: 'Master 5 questions (in "Mastered" category).', check: () => Object.values(performanceData).filter(q => q.category === 'mastered').length >= 5 },
        { id: 'problem_solver', name_fr: 'Résolveur de Problèmes', name_en: 'Problem Solver', description_fr: 'Faites passer 3 questions de "Problématiques" à une meilleure catégorie.', description_en: 'Improve 3 questions from "Problematic" to a better category.', check: () => Object.values(performanceData).filter(q => q.category !== 'problematic' && q.history.some(h => h.categoryAtTime === 'problematic')).length >= 3 },
        { id: 'perfect_card_pro', name_fr: 'Pro des Cartes Parfaites', name_en: 'Perfect Card Pro', description_fr: 'Obtenez 3 cartes de pratique parfaites consécutives.', description_en: 'Achieve 3 consecutive perfect practice cards.', check: () => consecutivePerfectCards >= 3 },
        { id: 'quiz_champion', name_fr: 'Champion du Quiz', name_en: 'Quiz Champion', description_fr: 'Répondez à toutes les 100 questions en mode Examen.', description_en: 'Answer all 100 questions in Test Mode.', check: () => Object.keys(savedSelectedAnswers).length === allQuizData.length }
    ];
    let earnedAchievements = [];

    // ––– Initialization on DOMContentLoaded –––
    document.addEventListener('DOMContentLoaded', () => {
      for (let i = 0; i < numPages; i++) {
        pageElements.push(document.getElementById(`page-${i}`));
      }

      loadPerformanceData();
      loadSavedAnswers();
      loadAiSavedAnswers();
      loadAchievements();

      initializeAiMode(); // Initialize AI mode structure early

      updateAllUIText();

      const shuffleToggle = document.getElementById('shuffleToggle');
      const shuffleButton = document.getElementById('shuffleButton');

      shuffleToggle.addEventListener('change', () => {
        if (shuffleToggle.checked) {
          quizOrder = Array.from(originalOrder);
          resetAllAnswers();
          renderCurrentPageQuestionsAndFeedback();
          shuffleButton.disabled = true;
        } else {
          shuffleButton.disabled = false;
        }
      });

      shuffleButton.addEventListener('click', () => {
        for (let i = quizOrder.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [quizOrder[i], quizOrder[j]] = [quizOrder[j], quizOrder[i]];
        }
        resetAllAnswers();
        renderCurrentPageQuestionsAndFeedback();
      });

      const quizStrategySelect = document.getElementById('quizStrategy');
      const numQuestionsInputContainer = document.getElementById('numQuestionsInputContainer');
      quizStrategySelect.addEventListener('change', () => {
        numQuestionsInputContainer.style.display = quizStrategySelect.value === 'random_x' ? 'flex' : 'none';
      });

      switchMode('learn'); // Start in a default mode
    });

    // ––– Language Switching –––
    function toggleLanguage() {
      currentLanguage = currentLanguage === 'fr' ? 'en' : 'fr';
      updateAllUIText();

      // Re-render content based on the current mode
      if (currentMode === 'test') {
        renderCurrentPageQuestionsAndFeedback();
      } else if (currentMode === 'ai') {
        renderCurrentAiPage();
      } else if (currentMode === 'learn' && currentPracticeCardQuestions.length > 0) {
        renderPracticeCardQuestions(currentPracticeCardQuestions);
      }
      
      if (document.getElementById('performanceStatsModal').style.display === 'block') {
        showPerformanceStatsModal();
      }
    }

    function updateAllUIText() {
      const s = uiStrings[currentLanguage];
      document.title = s.pageTitleDoc;
      document.getElementById('mainQuizTitle').textContent = s.mainQuizTitle;
      document.getElementById('mainQuizSubtitle').textContent = s.mainQuizSubtitle;
      document.getElementById('langToggleButton').textContent = s.langToggleButton;
      document.getElementById('chooseModeTitle').textContent = s.chooseModeTitle;
      document.getElementById('testModeButton').textContent = s.testModeButton;
      document.getElementById('learningModeButton').textContent = s.learningModeButton;
      document.getElementById('aiModeButton').textContent = s.aiModeButton;
      document.getElementById('shuffleLabel').textContent = s.defaultLabel;
      document.getElementById('shuffleButton').textContent = s.shuffleButton;
      document.getElementById('prevButton').textContent = s.prevButton;
      document.getElementById('nextButton').textContent = s.nextButton;
      document.getElementById('resetAllButton').textContent = s.resetButton;
      document.getElementById('viewResultsButton').textContent = s.viewResultsButton;
      document.getElementById('finalResultsTitle').textContent = s.finalResultsTitle;
      document.getElementById('learningToolsTitle').textContent = s.learningToolsTitle;
      document.getElementById('generatePracticeCardButton').textContent = s.generatePracticeCardButton;
      document.getElementById('viewStatsButton').textContent = s.viewStatsButton;
      if (document.getElementById('checkPracticeCardButton')) {
        document.getElementById('checkPracticeCardButton').textContent = s.checkPracticeCardButton;
      }
      if (document.getElementById('generateNewPracticeCardButton')) {
        document.getElementById('generateNewPracticeCardButton').textContent = s.generateNewPracticeCardButton;
      }
      document.getElementById('performanceStatsTitle').textContent = s.performanceStatsTitle;
      document.getElementById('achievementsTitle').textContent = s.achievementsTitle;
      document.querySelector('#quizStrategy option[value="default"]').textContent = s.optionDefault;
      document.querySelector('#quizStrategy option[value="unseen"]').textContent = s.optionUnseen;
      document.querySelector('#quizStrategy option[value="problematic"]').textContent = s.optionProblematic;
      document.querySelector('#quizStrategy option[value="random_x"]').textContent = s.optionRandomX;
      document.querySelector('label[for="numQuestions"]').textContent = s.numQuestionsLabel;
      document.querySelector('label[for="quizStrategy"]').textContent = s.generateLabel;

      pageElements.forEach((page, idx) => {
        const titleEl = document.getElementById(`pageTitle-${idx}`);
        if (!titleEl) return;
        const startQ = idx * questionsPerPage + 1;
        const endQ = Math.min((idx + 1) * questionsPerPage, allQuizData.length);
        titleEl.textContent = `${s.questionsLabel} ${startQ} – ${endQ}`;
      });

      // Update AI page titles if they exist
      aiPageElements.forEach((page, idx) => {
          const titleEl = document.getElementById(`ai-pageTitle-${idx}`);
          if (!titleEl) return;
          const startQ = idx * questionsPerPage + 1;
          const endQ = Math.min((idx + 1) * questionsPerPage, allAiQuizData.length);
          titleEl.textContent = `${s.questionsLabel} ${startQ} – ${endQ}`;
      });
      
      updateProgressBar('test');
      updateProgressBar('ai');
    }

    // ––– Mode Switching –––
    function switchMode(mode) {
      currentMode = mode;
      const testContainer = document.getElementById('testModeContainer');
      const learnContainer = document.getElementById('learningModeContainer');
      const aiContainer = document.getElementById('aiModeContainer');
      const shuffleControls = document.getElementById('shuffleControls');

      testContainer.style.display = 'none';
      learnContainer.style.display = 'none';
      aiContainer.style.display = 'none';
      shuffleControls.style.display = 'none';

      if (mode === 'test') {
        testContainer.style.display = 'block';
        shuffleControls.style.display = 'flex';
        updateNavigation();
        renderCurrentPageQuestionsAndFeedback();
        updateProgressBar('test');
      } else if (mode === 'learn') {
        learnContainer.style.display = 'block';
        document.getElementById('practiceQuestionsDisplayArea').innerHTML = '';
        document.getElementById('checkPracticeCardButton').style.display = 'none';
        document.getElementById('practiceCardScoreText').textContent = '';
        document.getElementById('generateNewPracticeCardButton').style.display = 'none';
        document.getElementById('practiceCardProgress').textContent = '';
      } else if (mode === 'ai') {
        if (allAiQuizData.length > 0) {
          aiContainer.style.display = 'block';
          navigateAiPage(aiCurrentPageIndex, true); // Go to current page and force render
          updateProgressBar('ai');
        } else {
            // Fallback if AI mode is selected but no data exists
            // Or if AI mode is selected but allAiQuizData is empty
            showNotification(uiStrings[currentLanguage].noQuestionsAvailableForPractice, 'error');
            switchMode('learn'); // Fallback to learning mode
        }
      }
    }

    // ––– Render Current Page (Test Mode) –––
    function renderCurrentPageQuestionsAndFeedback() {
      const pageEl = pageElements[currentPageIndex];
      if (!pageEl) return;

      const heading = pageEl.querySelector('.page-title');
      pageEl.innerHTML = heading ? heading.outerHTML : '';

      const startIdx = currentPageIndex * questionsPerPage;
      const endIdx = Math.min(startIdx + questionsPerPage, allQuizData.length);

      for (let i = startIdx; i < endIdx; i++) {
        const dataIdx = quizOrder[i];
        pageEl.appendChild(createQuestionElement(allQuizData[dataIdx], 'q'));
      }

      addCheckButtonAndScoreToPage(currentPageIndex);
      loadSavedAnswersForPage(pageEl, 'q', savedSelectedAnswers);

      // Re-apply feedback if page was already attempted in test mode
      if (pageScores[currentPageIndex] && pageScores[currentPageIndex].attempted) {
        checkAnswersForPage(currentPageIndex, false); // Don't recalculate score, just update display
      }
    }

    // ––– Create a Single Question Block (Generic) –––
    function createQuestionElement(qData, prefix = 'q', displayIndex = null) {
      const s = uiStrings[currentLanguage];
      const div = document.createElement('div');
      div.className = 'question-block';
      const actualDisplayIndex = displayIndex !== null ? displayIndex : qData.qNum;

      div.innerHTML = `
        <p class="text-gray-800 text-base"><b>${actualDisplayIndex}.</b> ${qData.text[currentLanguage]}</p>
        <div class="mt-3 space-y-2">
          <label class="flex items-center p-2 rounded-md hover:bg-gray-50 transition-colors duration-150">
            <input type="radio" name="${prefix}${qData.qNum}" value="true">
            <span class="ml-3 text-gray-700 true-label">${s.trueLabel}</span>
          </label>
          <label class="flex items-center p-2 rounded-md hover:bg-gray-50 transition-colors duration-150">
            <input type="radio" name="${prefix}${qData.qNum}" value="false">
            <span class="ml-3 text-gray-700 false-label">${s.falseLabel}</span>
          </label>
        </div>
        <p id="${prefix}${qData.qNum}-result" class="result mt-2"></p>
      `;

      const radioButtons = div.querySelectorAll(`input[name="${prefix}${qData.qNum}"]`);
      radioButtons.forEach(radio => {
          radio.addEventListener('change', (event) => {
              const selectedVal = event.target.value;
              const resultEl = document.getElementById(`${prefix}${qData.qNum}-result`);
              if (resultEl) {
                  resultEl.textContent = ''; // Clear previous feedback
                  resultEl.className = 'result mt-2';
              }
              
              if (prefix === 'q') { // Test Mode
                  savedSelectedAnswers[qData.qNum] = selectedVal;
                  saveSavedAnswers();
                  updateProgressBar('test');
                  // Disable all radios for this question once one is selected
                  radioButtons.forEach(rb => { rb.disabled = true; });
              } else if (prefix === 'aiq') { // AI Mode
                  aiSavedSelectedAnswers[qData.qNum] = selectedVal;
                  saveAiSavedAnswers();
                  updateProgressBar('ai');
                  // Disable all radios for this question once one is selected
                  radioButtons.forEach(rb => { rb.disabled = true; });
              } else if (prefix === 'pq') { // Learning Mode
                  // savedSelectedAnswers[qData.qNum] = selectedVal; // No need to save learning mode answers directly, performanceData handles it
                  // saveSavedAnswers();
                  setTimeout(() => {
                      processSingleQuestionAnswer(qData, selectedVal, prefix);
                      updatePracticeCardProgress();
                  }, 750);
              }
          });
      });
      return div;
    }

    // ––– Add “Check Answers” Button & Score Placeholder (Test Mode) –––
    function addCheckButtonAndScoreToPage(pageIdx) {
      const s = uiStrings[currentLanguage];
      const pageEl = pageElements[pageIdx];
      if (!pageEl) return;

      const existingBtn = pageEl.querySelector('.check-answers-btn');
      if (existingBtn) existingBtn.remove();
      const existingScoreP = pageEl.querySelector('.page-score-display');
      if (existingScoreP) existingScoreP.remove();

      const btn = document.createElement('button');
      btn.onclick = () => checkAnswersForPage(pageIdx, true);
      btn.className = 'check-answers-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg w-full mt-6 shadow-md transition-colors duration-150';
      btn.textContent = `${s.checkAnswersButton} (${s.pageIndicatorPrefix} ${pageIdx + 1})`;
      pageEl.appendChild(btn);

      const scoreP = document.createElement('p');
      scoreP.id = `score-page-${pageIdx}`;
      scoreP.className = 'page-score-display text-center font-semibold text-lg mt-4 text-gray-800';
      pageEl.appendChild(scoreP);
    }

    // ––– Update Pagination Controls (Test Mode) –––
    function updateNavigation() {
      const s = uiStrings[currentLanguage];
      pageElements.forEach((page, idx) => {
        if (!page) return;
        page.style.display = (idx === currentPageIndex) ? 'block' : 'none';
        page.classList.toggle('active', idx === currentPageIndex);
      });
      document.getElementById('pageIndicator').textContent = `${s.pageIndicatorPrefix} ${currentPageIndex + 1} / ${numPages}`;
      document.getElementById('prevButton').disabled = currentPageIndex === 0;
      document.getElementById('nextButton').disabled = currentPageIndex === numPages - 1;

      const container = document.querySelector('.container.mx-auto');
      if (container) container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function navigatePage(dir) {
      const newIdx = currentPageIndex + dir;
      if (newIdx >= 0 && newIdx < numPages) {
        currentPageIndex = newIdx;
        updateNavigation();
        renderCurrentPageQuestionsAndFeedback();
      }
    }

    // ––– Process a Single Question's Answer (Learning Mode) –––
    // This function now specifically handles learning mode feedback and performance tracking
    function processSingleQuestionAnswer(qData, selectedVal, prefix) {
        const s = uiStrings[currentLanguage];
        const resultEl = document.getElementById(`${prefix}${qData.qNum}-result`);

        if (!resultEl) return;

        const wasCorrect = selectedVal === qData.answer;

        let feedbackText = '';
        let feedbackClass = '';

        if (wasCorrect) {
            feedbackText = s.correctFeedback;
            feedbackClass = "result text-green-700";
            if (prefix === 'pq') { // Only track streak and show encouragement in learning mode
                currentLearningStreak++;
                if (currentLearningStreak > 0 && currentLearningStreak % 5 === 0) { // Notify every 5 correct answers
                    showNotification(s.streakNotification.replace('{count}', currentLearningStreak), 'success');
                }
                // Add random encouragement for correct answers with 50% probability
                if (Math.random() < 0.5) {
                    feedbackText += ` (${s.encouragementCorrect[Math.floor(Math.random() * s.encouragementCorrect.length)]})`;
                }
            }
        } else {
            const correctText = (qData.answer === "true") ? s.trueLabel : s.falseLabel;
            feedbackText = `${s.incorrectFeedbackPrefix}${correctText}.`;
            feedbackClass = "result text-red-700";
            if (prefix === 'pq') { // Reset streak in learning mode
                currentLearningStreak = 0;
            }
            // Add random encouragement for incorrect answers with 50% probability
            if (Math.random() < 0.5) {
                feedbackText += ` (${s.encouragementIncorrect[Math.floor(Math.random() * s.encouragementIncorrect.length)]})`;
            }
        }
        
        resultEl.textContent = feedbackText;
        resultEl.className = feedbackClass;

        // Update performance data ONLY if in LEARNING MODE (prefix === 'pq')
        if (prefix === 'pq') {
            const qNumForPerf = qData.qNum;
            if (!performanceData[qNumForPerf]) {
                performanceData[qNumForPerf] = { qNumOriginal: qNumForPerf, correctAttempts: 0, incorrectAttempts: 0, category: 'unseen', history: [], lastSeenInQuiz: 0 };
            }
            const questionPerf = performanceData[qNumForPerf];

            if (wasCorrect) {
                questionPerf.correctAttempts++;
            } else {
                questionPerf.incorrectAttempts++;
            }
            // Store category at the time of answering for potential achievement checks
            questionPerf.history.push({ timestamp: Date.now(), correct: wasCorrect, categoryAtTime: questionPerf.category }); // Use current category
            if (questionPerf.history.length > 10) questionPerf.history.shift(); // Keep last 10 history items

            updateQuestionCategory(qNumForPerf);
            savePerformanceData(); // Save after each question update
            checkAchievements(); // Check achievements after performance data update
        }
    }

    // ––– Check Answers for One Page (Test Mode) –––
    // This function now solely handles feedback display and scoring for Test Mode.
    // It DOES NOT update performanceData categories or streaks.
    function checkAnswersForPage(pageIdx, calculateScore = true) {
      if (currentMode !== 'test') return;
      const s = uiStrings[currentLanguage];
      let score = 0;
      const startIdx = pageIdx * questionsPerPage;
      const endIdx = Math.min(startIdx + questionsPerPage, allQuizData.length);
      const questionsOnThisPage = endIdx - startIdx;
      
      for (let i = startIdx; i < endIdx; i++) {
        const qData = allQuizData[quizOrder[i]]; // Use quizOrder for test mode
        const radios = document.getElementsByName(`q${qData.qNum}`);
        let selectedVal = null;
        radios.forEach(rb => {
            if (rb.checked) selectedVal = rb.value;
            rb.disabled = true; // Disable all radios for this question after checking
        });
        const resultEl = document.getElementById(`q${qData.qNum}-result`);
        if (resultEl) {
            if (selectedVal !== null) {
                const wasCorrect = selectedVal === qData.answer;
                if (wasCorrect) {
                    resultEl.textContent = s.correctFeedback;
                    resultEl.className = "result text-green-700";
                    score++; // Increment score for test mode if correct
                } else {
                    const correctText = (qData.answer === "true") ? s.trueLabel : s.falseLabel;
                    resultEl.textContent = `${s.incorrectFeedbackPrefix}${correctText}.`;
                    resultEl.className = "result text-red-700";
                }
            } else {
                resultEl.textContent = s.selectAnswerPrompt;
                resultEl.className = "result text-red-700";
            }
        }
      }

      if (calculateScore) {
        pageScores[pageIdx] = { score: score, totalQuestions: questionsOnThisPage, attempted: true };
      }
      
      const scoreEl = document.getElementById(`score-page-${pageIdx}`);
      if (scoreEl && pageScores[pageIdx]) {
        scoreEl.textContent = `${s.scoreForPageLabel}: ${pageScores[pageIdx].score} / ${pageScores[pageIdx].totalQuestions}`;
      }
      // Test mode does not influence performanceData categories or streaks directly.
      // Achievements are checked here as they might depend on overall test completion.
      checkAchievements();
    }

    // ––– Save/Load Selected Answers –––
    function loadSavedAnswers() {
      const saved = localStorage.getItem('quizSelectedAnswers_v1');
      savedSelectedAnswers = saved ? JSON.parse(saved) : {};
    }
    function saveSavedAnswers() {
      localStorage.setItem('quizSelectedAnswers_v1', JSON.stringify(savedSelectedAnswers));
    }
    function loadAiSavedAnswers() {
        const saved = localStorage.getItem('aiQuizSelectedAnswers_v1');
        aiSavedSelectedAnswers = saved ? JSON.parse(saved) : {};
    }
    function saveAiSavedAnswers() {
        localStorage.setItem('aiQuizSelectedAnswers_v1', JSON.stringify(aiSavedSelectedAnswers));
    }

    // Generic function to load saved answers for a given page and prefix
    function loadSavedAnswersForPage(pageElement, prefix, answersObject) {
        const questionBlocks = pageElement.querySelectorAll('.question-block');
        questionBlocks.forEach(block => {
            const qNum = parseInt(block.querySelector('input[type="radio"]').name.replace(prefix, ''));
            if (answersObject[qNum]) {
                const radios = block.querySelectorAll(`input[name="${prefix}${qNum}"]`);
                radios.forEach(radio => {
                    if (radio.value === answersObject[qNum]) {
                        radio.checked = true;
                        // For test mode (q) and AI mode (aiq), disable radios if an answer is loaded
                        if (prefix === 'q' || prefix === 'aiq') {
                            radios.forEach(rb => { rb.disabled = true; });
                        }
                    }
                });
            }
        });
    }

    // ––– Reset All Answers & Scores –––
    function resetAllAnswers() {
      const s = uiStrings[currentLanguage];
      showConfirmationModal(s.confirmResetPerformance, () => {
        allQuizData.forEach((qData) => {
          // Reset main quiz questions
          const radios = document.getElementsByName(`q${qData.qNum}`);
          radios.forEach((rb) => { rb.checked = false; rb.disabled = false; });
          const resEl = document.getElementById(`q${qData.qNum}-result`);
          if (resEl) { resEl.textContent = ''; resEl.className = 'result mt-2'; }
          
          // Reset practice card questions (if currently rendered)
          const pqRadios = document.getElementsByName(`pq${qData.qNum}`);
          pqRadios.forEach((rb) => { rb.checked = false; rb.disabled = false; });
          const pqResEl = document.getElementById(`pq${qData.qNum}-result`);
          if (pqResEl) { pqResEl.textContent = ''; pqResEl.className = 'result mt-2'; }
        });

        // Reset main quiz scores and saved answers
        pageScores = Array(numPages).fill(null).map(() => ({ score: 0, totalQuestions: 0, attempted: false }));
        for (let i = 0; i < numPages; i++) {
          const scEl = document.getElementById(`score-page-${i}`);
          if (scEl) scEl.textContent = '';
        }
        savedSelectedAnswers = {}; // Clear saved answers for main quiz
        saveSavedAnswers();

        // Reset performance data (learning stats)
        performanceData = {};
        allQuizData.forEach(qData => {
          performanceData[qData.qNum] = { qNumOriginal: qData.qNum, correctAttempts: 0, incorrectAttempts: 0, category: 'unseen', history: [], lastSeenInQuiz: 0 };
        });
        quizCounter = 0;
        currentLearningStreak = 0;
        consecutivePerfectCards = 0;
        savePerformanceData();

        // Reset achievements by reloading them as empty (or selectively if desired)
        earnedAchievements = [];
        saveAchievements();

        showNotification(s.performanceDataReset, 'success');
        renderCurrentPageQuestionsAndFeedback(); // Re-render current page in test mode
        updateProgressBar('test'); // Reset test mode progress bar
      });
    }

    // ––– AI Quiz Mode Functions –––

    function initializeAiMode() {
        const aiContainer = document.getElementById('aiModeContainer');
        const aiModeButton = document.getElementById('aiModeButton');
        const s = uiStrings[currentLanguage];

        if (typeof allAiQuizData === 'undefined' || allAiQuizData.length === 0) {
            aiModeButton.disabled = true;
            return;
        }
        aiModeButton.disabled = false;

        numAiPages = Math.ceil(allAiQuizData.length / questionsPerPage);
        aiPageScores = Array(numAiPages).fill(null).map(() => ({ score: 0, totalQuestions: 0, attempted: false }));

        // Build the structure
        aiContainer.innerHTML = `
            <h2 class="text-3xl font-bold text-center mb-2 text-teal-700" id="aiQuizTitle">${s.aiQuizTitle}</h2>
            <div class="w-full bg-gray-200 rounded-full h-4 my-4 relative">
                <div id="aiProgressBar" class="bg-teal-600 h-4 rounded-full" style="width: 0%;"></div>
                <span id="aiProgressText" class="absolute inset-0 flex justify-center items-center text-white font-semibold text-xs">0% Complete</span>
            </div>
            <div id="ai-pages-container"></div>
            <footer class="mt-10 pt-6 border-t border-gray-300">
                <div class="navigation-controls flex justify-between items-center mb-4">
                    <button id="aiPrevButton" onclick="navigateAiPage(-1)" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150">${s.prevButton}</button>
                    <span id="aiPageIndicator" class="text-gray-700 font-medium text-lg">Page 1 / ${numAiPages}</span>
                    <button id="aiNextButton" onclick="navigateAiPage(1)" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150">${s.nextButton}</button>
                </div>
                <div class="mt-6 space-y-3 md:space-y-0 md:flex md:space-x-3">
                    <button onclick="showFinalResultsModal('ai')" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg w-full md:w-auto shadow-md transition-colors duration-150">${s.viewResultsButton}</button>
                    <button onclick="resetAiQuiz()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg w-full md:w-auto shadow-md transition-colors duration-150" id="resetAiQuizButton">${s.resetAiQuizButton}</button>
                </div>
            </footer>
        `;

        const pagesContainer = document.getElementById('ai-pages-container');
        aiPageElements.length = 0; // Clear previous elements
        for (let i = 0; i < numAiPages; i++) {
            const pageDiv = document.createElement('div');
            pageDiv.id = `ai-page-${i}`;
            pageDiv.className = 'ai-quiz-page';
            const startQ = i * questionsPerPage + 1;
            const endQ = Math.min((i + 1) * questionsPerPage, allAiQuizData.length);
            pageDiv.innerHTML = `<h2 id="ai-pageTitle-${i}" class="page-title text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">${s.questionsLabel} ${startQ} – ${endQ}</h2>`;
            pagesContainer.appendChild(pageDiv);
            aiPageElements.push(pageDiv);
        }
    }
    
    function renderCurrentAiPage() {
        const pageEl = aiPageElements[aiCurrentPageIndex];
        if (!pageEl) return;

        const heading = pageEl.querySelector('.page-title');
        pageEl.innerHTML = heading ? heading.outerHTML : '';

        const startIdx = aiCurrentPageIndex * questionsPerPage;
        const endIdx = Math.min(startIdx + questionsPerPage, allAiQuizData.length);

        for (let i = startIdx; i < endIdx; i++) {
            pageEl.appendChild(createQuestionElement(allAiQuizData[i], 'aiq'));
        }

        addCheckButtonAndScoreToAiPage(aiCurrentPageIndex);
        loadSavedAnswersForPage(pageEl, 'aiq', aiSavedSelectedAnswers);

        if (aiPageScores[aiCurrentPageIndex] && aiPageScores[aiCurrentPageIndex].attempted) {
            checkAnswersForAiPage(aiCurrentPageIndex, false);
        }
    }

    function addCheckButtonAndScoreToAiPage(pageIdx) {
        const s = uiStrings[currentLanguage];
        const pageEl = aiPageElements[pageIdx];
        if (!pageEl) return;
        
        let btn = pageEl.querySelector('.check-answers-btn');
        if (!btn) {
            btn = document.createElement('button');
            btn.className = 'check-answers-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg w-full mt-6 shadow-md transition-colors duration-150';
            pageEl.appendChild(btn);
        }
        btn.onclick = () => checkAnswersForAiPage(pageIdx, true);
        btn.textContent = `${s.checkAnswersButton} (${s.pageIndicatorPrefix} ${pageIdx + 1})`;
        
        let scoreP = pageEl.querySelector('.page-score-display');
        if (!scoreP) {
            scoreP = document.createElement('p');
            scoreP.className = 'page-score-display text-center font-semibold text-lg mt-4 text-gray-800';
            pageEl.appendChild(scoreP);
        }
        scoreP.id = `ai-score-page-${pageIdx}`;
    }

    function navigateAiPage(dir, forceRender = false) {
        const newIdx = (forceRender) ? dir : aiCurrentPageIndex + dir;
        if (newIdx >= 0 && newIdx < numAiPages) {
            aiCurrentPageIndex = newIdx;
            const s = uiStrings[currentLanguage];
            
            aiPageElements.forEach((page, idx) => {
                page.style.display = (idx === aiCurrentPageIndex) ? 'block' : 'none';
                page.classList.toggle('active', idx === aiCurrentPageIndex);
            });

            document.getElementById('aiPageIndicator').textContent = `${s.pageIndicatorPrefix} ${aiCurrentPageIndex + 1} / ${numAiPages}`;
            document.getElementById('aiPrevButton').disabled = aiCurrentPageIndex === 0;
            document.getElementById('aiNextButton').disabled = aiCurrentPageIndex === numAiPages - 1;
            
            renderCurrentAiPage();

            const container = document.querySelector('.container.mx-auto');
            if (container) container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    function checkAnswersForAiPage(pageIdx, calculateScore = true) {
        const s = uiStrings[currentLanguage];
        let score = 0;
        const startIdx = pageIdx * questionsPerPage;
        const endIdx = Math.min(startIdx + questionsPerPage, allAiQuizData.length);
        const questionsOnThisPage = endIdx - startIdx;
        
        for (let i = startIdx; i < endIdx; i++) {
            const qData = allAiQuizData[i];
            const radios = document.getElementsByName(`aiq${qData.qNum}`);
            let selectedVal = null;
            radios.forEach(rb => {
                if (rb.checked) selectedVal = rb.value;
                rb.disabled = true; // Disable radios after checking
            });
            const resultEl = document.getElementById(`aiq${qData.qNum}-result`);
            if (resultEl) {
                if (selectedVal !== null) {
                    const wasCorrect = selectedVal === qData.answer;
                    if (wasCorrect) {
                        resultEl.textContent = s.correctFeedback;
                        resultEl.className = "result text-green-700";
                        if(calculateScore) score++;
                    } else {
                        const correctText = (qData.answer === "true") ? s.trueLabel : s.falseLabel;
                        resultEl.textContent = `${s.incorrectFeedbackPrefix}${correctText}.`;
                        resultEl.className = "result text-red-700";
                    }
                } else {
                    resultEl.textContent = s.selectAnswerPrompt;
                    resultEl.className = "result text-red-700";
                }
            }
        }
        if (calculateScore) {
            aiPageScores[pageIdx] = { score: score, totalQuestions: questionsOnThisPage, attempted: true };
        }
        const scoreEl = document.getElementById(`ai-score-page-${pageIdx}`);
        if (scoreEl && aiPageScores[pageIdx]) {
            scoreEl.textContent = `${s.scoreForPageLabel}: ${aiPageScores[pageIdx].score} / ${aiPageScores[pageIdx].totalQuestions}`;
        }
        // AI mode does not influence performanceData categories or streaks directly.
    }
    
    function resetAiQuiz() {
        const s = uiStrings[currentLanguage];
        showConfirmationModal(s.confirmResetAiQuiz, () => {
            allAiQuizData.forEach(qData => {
                const radios = document.getElementsByName(`aiq${qData.qNum}`);
                radios.forEach(rb => { rb.checked = false; rb.disabled = false; });
                const resEl = document.getElementById(`aiq${qData.qNum}-result`);
                if(resEl) resEl.textContent = '';
            });
            aiPageScores = Array(numAiPages).fill(null).map(() => ({ score: 0, totalQuestions: 0, attempted: false }));
            aiSavedSelectedAnswers = {};
            saveAiSavedAnswers();
            showNotification(s.aiQuizResetMsg, 'success');
            renderCurrentAiPage();
            updateProgressBar('ai');
        });
    }

    // ––– Utility Functions (Modals, Notifications, etc.) –––
    let confirmationModalCallback = null;
    function showConfirmationModal(message, callback) {
        const modal = document.getElementById('customConfirmationModal');
        modal.querySelector('.modal-body p').textContent = message;
        modal.style.display = 'block';
        confirmationModalCallback = callback;
        document.getElementById('confirmYes').onclick = () => {
            if (confirmationModalCallback) confirmationModalCallback();
            closeConfirmationModal();
        };
        document.getElementById('confirmNo').onclick = closeConfirmationModal;
    }
    function closeConfirmationModal() {
        document.getElementById('customConfirmationModal').style.display = 'none';
        confirmationModalCallback = null;
    }

    function showNotification(message, type = 'info') {
      const note = document.getElementById('notificationArea');
      if (!note) return;
      note.textContent = message;
      note.className = `fixed top-5 right-5 p-4 rounded-md shadow-lg z-100 text-white font-medium ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
      note.style.display = 'block';
      setTimeout(() => { note.style.display = 'none'; }, 3000);
    }

    function showFinalResultsModal(mode) {
      const s = uiStrings[currentLanguage];
      const body = document.getElementById('finalResultsBody');
      const title = document.getElementById('finalResultsTitle');
      body.innerHTML = '';
      let overallAchieved = 0;
      let overallTotal = 0;
      let anyAttempted = false;
      let scoresToShow, titleText;

      if (mode === 'test') {
          scoresToShow = pageScores;
          titleText = s.finalResultsTitle;
      } else { // 'ai'
          scoresToShow = aiPageScores;
          titleText = s.aiResultsTitle;
      }
      title.textContent = titleText;
      
      scoresToShow.forEach((pageScore, idx) => {
        if (pageScore && pageScore.attempted) {
          anyAttempted = true;
          const p = document.createElement('p');
          p.className = 'text-gray-700';
          p.textContent = `${s.pageIndicatorPrefix} ${idx + 1}: ${pageScore.score} / ${pageScore.totalQuestions}`;
          body.appendChild(p);
          overallAchieved += pageScore.score;
          overallTotal += pageScore.totalQuestions;
        }
      });

      if (!anyAttempted) {
        body.textContent = s.noResultsYet;
        document.getElementById('overallScoreText').textContent = '';
      } else {
        document.getElementById('overallScoreText').textContent = `${s.overallScoreLabel}: ${overallAchieved} / ${overallTotal}`;
      }
      document.getElementById('finalResultsModal').style.display = 'block';
    }
    function closeFinalResultsModal() {
      document.getElementById('finalResultsModal').style.display = 'none';
    }

    // ––– Performance Tracking & Practice Card Logic (Unchanged) –––
    function loadPerformanceData() {
      const saved = localStorage.getItem('quizPerformanceData_v1');
      if (saved) {
        performanceData = JSON.parse(saved);
        const savedQuizCounter = localStorage.getItem('quizCounter_v1');
        if (savedQuizCounter) quizCounter = parseInt(savedQuizCounter, 10);
        const savedLearningStreak = localStorage.getItem('currentLearningStreak_v1');
        if (savedLearningStreak) currentLearningStreak = parseInt(savedLearningStreak, 10);
        const savedPerfectCards = localStorage.getItem('consecutivePerfectCards_v1');
        if (savedPerfectCards) consecutivePerfectCards = parseInt(savedPerfectCards, 10);
        allQuizData.forEach(qData => {
          if (!performanceData[qData.qNum]) {
            performanceData[qData.qNum] = { qNumOriginal: qData.qNum, correctAttempts: 0, incorrectAttempts: 0, category: 'unseen', history: [], lastSeenInQuiz: 0 };
          } else {
              if (performanceData[qData.qNum].lastSeenInQuiz === undefined) performanceData[qData.qNum].lastSeenInQuiz = 0;
              performanceData[qData.qNum].history.forEach(h => { if (h.categoryAtTime === undefined) h.categoryAtTime = 'unknown'; });
              updateQuestionCategory(qData.qNum);
          }
        });
      } else {
        allQuizData.forEach(qData => {
          performanceData[qData.qNum] = { qNumOriginal: qData.qNum, correctAttempts: 0, incorrectAttempts: 0, category: 'unseen', history: [], lastSeenInQuiz: 0 };
        });
        quizCounter = 0;
        currentLearningStreak = 0;
        consecutivePerfectCards = 0;
      }
    }
    function savePerformanceData() {
      localStorage.setItem('quizPerformanceData_v1', JSON.stringify(performanceData));
      localStorage.setItem('quizCounter_v1', quizCounter.toString());
      localStorage.setItem('currentLearningStreak_v1', currentLearningStreak.toString());
      localStorage.setItem('consecutivePerfectCards_v1', consecutivePerfectCards.toString());
    }
    function updateQuestionCategory(qNumKey) {
        const stats = performanceData[qNumKey];
        if (!stats) return;
        const totalAttempts = stats.correctAttempts + stats.incorrectAttempts;
        const historyLength = stats.history.length;
        const recentHistory = stats.history.slice(-3);
        const recentIncorrectCount = recentHistory.filter(h => !h.correct).length;
        if (totalAttempts === 0) { stats.category = 'unseen'; return; }
        if (totalAttempts === 1) { stats.category = 'new-learning'; return; }
        if (historyLength >= 3 && recentIncorrectCount === 3) { stats.category = 'problematic'; return; }
        const correctRatio = totalAttempts > 0 ? stats.correctAttempts / totalAttempts : 0;
        const recentCorrectCount = recentHistory.filter(h => h.correct).length;
        if (stats.correctAttempts >= 5 && correctRatio >= 0.9 && recentCorrectCount === 3 && historyLength >= 3) { stats.category = 'mastered'; return; }
        stats.category = 'learning-normal';
    }
    function generatePracticeCardFromUI() {
        const quizStrategy = document.getElementById('quizStrategy').value;
        let numQuestions = DEFAULT_PRACTICE_CARD_SIZE;
        if (quizStrategy === 'random_x') {
            numQuestions = parseInt(document.getElementById('numQuestions').value, 10);
            if (isNaN(numQuestions) || numQuestions < 1 || numQuestions > allQuizData.length) {
                showNotification(uiStrings[currentLanguage].invalidNumQuestions, 'error');
                return;
            }
        }
        generatePracticeCard(quizStrategy, numQuestions);
    }
    function generatePracticeCard(strategy = 'default', numQuestionsToGenerate = DEFAULT_PRACTICE_CARD_SIZE) {
      quizCounter++;
      const s = uiStrings[currentLanguage];
      currentPracticeCardQuestions = [];
      currentPracticeCardQuestionIndex = 0;
      const candidates = { problematic: [], 'learning-bad': [], 'learning-normal': [], 'learning-good': [], 'new-learning': [], unseen: [], mastered: [] };
      allQuizData.forEach(qData => { (candidates[performanceData[qData.qNum]?.category || 'unseen'] || []).push(qData); });
      Object.values(candidates).forEach(cat => cat.sort(() => 0.5 - Math.random()));

      if (strategy === 'unseen') {
          currentPracticeCardQuestions = candidates.unseen.slice(0, numQuestionsToGenerate);
      } else if (strategy === 'problematic') {
          currentPracticeCardQuestions = candidates.problematic.slice(0, numQuestionsToGenerate);
      } else if (strategy === 'random_x') {
          const allAvailable = Object.values(candidates).flat();
          allAvailable.sort(() => 0.5 - Math.random());
          currentPracticeCardQuestions = allAvailable.slice(0, numQuestionsToGenerate);
      } else {
          // Default mixed strategy...
          const targetCounts = { problematic: 3, 'learning-bad': 2, 'learning-normal': 1, 'learning-good': 1, 'new-learning': 1, unseen: 1, mastered: 0 };
          const priorityOrder = ['problematic', 'learning-bad', 'new-learning', 'unseen', 'learning-normal', 'learning-good'];
          let count = 0;
          for (const category of priorityOrder) {
              let needed = targetCounts[category] || 0;
              while (needed > 0 && candidates[category].length > 0 && count < DEFAULT_PRACTICE_CARD_SIZE) {
                  currentPracticeCardQuestions.push(candidates[category].shift());
                  count++;
                  needed--;
              }
          }
          let remainingPool = Object.values(candidates).flat();
          remainingPool.sort(() => 0.5 - Math.random());
          while (count < DEFAULT_PRACTICE_CARD_SIZE && remainingPool.length > 0) {
              const nextQ = remainingPool.shift();
              if (!currentPracticeCardQuestions.find(q => q.qNum === nextQ.qNum)) {
                  currentPracticeCardQuestions.push(nextQ);
                  count++;
              }
          }
      }
      currentPracticeCardQuestions.sort(() => 0.5 - Math.random());
      if (currentPracticeCardQuestions.length === 0) {
        showNotification(s.noQuestionsAvailableForPractice, 'info');
        return;
      }
      currentPracticeCardQuestions.forEach(qData => { performanceData[qData.qNum].lastSeenInQuiz = quizCounter; });
      savePerformanceData();
      renderPracticeCardQuestions(currentPracticeCardQuestions);
      document.getElementById('checkPracticeCardButton').style.display = 'block';
      document.getElementById('practiceCardScoreText').textContent = '';
      document.getElementById('generateNewPracticeCardButton').style.display = 'none';
      updatePracticeCardProgress();
    }
    function renderPracticeCardQuestions(questionsToRender) {
      const displayArea = document.getElementById('practiceQuestionsDisplayArea');
      displayArea.innerHTML = '<p id="practiceCardProgress" class="text-center text-gray-600 font-medium mb-4"></p>';
      questionsToRender.forEach((qData, index) => {
        displayArea.appendChild(createQuestionElement(qData, 'pq', index + 1));
      });
      loadSavedAnswersForPage(displayArea, 'pq', savedSelectedAnswers);
    }
    function updatePracticeCardProgress() {
        const s = uiStrings[currentLanguage];
        const progressEl = document.getElementById('practiceCardProgress');
        if (!progressEl) return;
        let answeredCount = currentPracticeCardQuestions.filter(qData => document.querySelector(`input[name="pq${qData.qNum}"]:checked`)).length;
        progressEl.textContent = s.practiceCardProgress.replace('{current}', answeredCount).replace('{total}', currentPracticeCardQuestions.length);
    }
    function checkPracticeCardAnswers() {
      const s = uiStrings[currentLanguage];
      let score = 0;
      let answeredCount = 0;
      currentPracticeCardQuestions.forEach(qData => {
        const radios = document.getElementsByName(`pq${qData.qNum}`);
        let selectedVal = null;
        radios.forEach(rb => {
            if (rb.checked) selectedVal = rb.value;
            rb.disabled = true;
        });
        if (selectedVal !== null) {
          answeredCount++;
          processSingleQuestionAnswer(qData, selectedVal, 'pq');
          if (performanceData[qData.qNum]?.history.slice(-1)[0]?.correct) score++;
        } else {
            const resultEl = document.getElementById(`pq${qData.qNum}-result`);
            if (resultEl) { resultEl.textContent = s.selectAnswerPrompt; resultEl.className = "result text-red-700"; }
        }
      });
      if (answeredCount === currentPracticeCardQuestions.length) {
          document.getElementById('practiceCardScoreText').textContent = `${s.scoreForPageLabel}: ${score} / ${currentPracticeCardQuestions.length}`;
          document.getElementById('generateNewPracticeCardButton').style.display = 'block';
          document.getElementById('checkPracticeCardButton').style.display = 'none';
          if (score === currentPracticeCardQuestions.length) {
              consecutivePerfectCards++;
              showNotification(s.perfectCardNotification.replace('{count}', consecutivePerfectCards), 'success');
          } else {
              consecutivePerfectCards = 0;
          }
          if (score === currentPracticeCardQuestions.length - 1 && currentPracticeCardQuestions.length > 1) {
              showNotification(s.goodJob90Percent, 'success');
          }
          savePerformanceData();
          checkAchievements();
      } else {
          showNotification(s.selectAnswerPrompt, 'info');
      }
    }
    function showPerformanceStatsModal() {
        // This function remains large and complex, keeping as is for now.
        const s = uiStrings[currentLanguage];
        const body = document.getElementById('performanceStatsBody');
        body.innerHTML = '';
        const achievementsTitle = document.createElement('h3');
        achievementsTitle.className = 'text-xl font-semibold mb-2 text-gray-700';
        achievementsTitle.textContent = s.achievementsTitle;
        body.appendChild(achievementsTitle);
        const achievementsDisplay = document.createElement('div');
        achievementsDisplay.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6';
        if (earnedAchievements.length > 0) {
            earnedAchievements.forEach(achId => {
                const achievement = achievements.find(a => a.id === achId);
                if (achievement) {
                    const achEl = document.createElement('div');
                    achEl.className = 'bg-green-100 border border-green-300 rounded-lg p-3 flex items-center space-x-3 shadow-sm';
                    achEl.innerHTML = `<svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><div><p class="font-semibold text-green-800">${achievement[`name_${currentLanguage}`]}</p><p class="text-green-700 text-sm">${achievement[`description_${currentLanguage}`]}</p></div>`;
                    achievementsDisplay.appendChild(achEl);
                }
            });
        } else {
            const noAch = document.createElement('p');
            noAch.className = 'text-gray-500 italic';
            noAch.textContent = "No achievements earned yet.";
            achievementsDisplay.appendChild(noAch);
        }
        body.appendChild(achievementsDisplay);
        document.getElementById('performanceStatsModal').style.display = 'block';
    }
    function closePerformanceStatsModal() {
      document.getElementById('performanceStatsModal').style.display = 'none';
    }

    // ––– Gamification & Progress Bar –––
    function updateProgressBar(mode) {
        let progressBar, progressText, s, answeredCount, totalQuestions, answersObject;

        if (mode === 'test') {
            progressBar = document.getElementById('testProgressBar');
            progressText = document.getElementById('testProgressText');
            s = uiStrings[currentLanguage];
            answersObject = savedSelectedAnswers;
            totalQuestions = allQuizData.length;
        } else if (mode === 'ai') {
            progressBar = document.getElementById('aiProgressBar');
            progressText = document.getElementById('aiProgressText');
            s = uiStrings[currentLanguage];
            answersObject = aiSavedSelectedAnswers;
            totalQuestions = allAiQuizData.length;
        } else {
            return; // Not a mode with a progress bar
        }
        
        if(!progressBar || !progressText) return; // Exit if the elements aren't on the page

        answeredCount = Object.keys(answersObject).length;
        const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;

        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressText.textContent = `${answeredCount} / ${totalQuestions} (${percentage}${s.percentComplete})`;
    }
    function loadAchievements() {
        const saved = localStorage.getItem('earnedAchievements_v1');
        earnedAchievements = saved ? JSON.parse(saved) : [];
    }
    function saveAchievements() {
        localStorage.setItem('earnedAchievements_v1', JSON.stringify(earnedAchievements));
    }
    function checkAchievements() {
        const s = uiStrings[currentLanguage];
        achievements.forEach(achievement => {
            if (!earnedAchievements.includes(achievement.id) && achievement.check()) {
                earnedAchievements.push(achievement.id);
                saveAchievements();
                showNotification(s.achievementUnlocked.replace('{name}', achievement[`name_${currentLanguage}`]), 'success');
            }
        });
    }

    window.onclick = function (event) {
      const modals = ['finalResultsModal', 'performanceStatsModal', 'customConfirmationModal'];
      modals.forEach(id => {
          if (event.target == document.getElementById(id)) {
              document.getElementById(id).style.display = 'none';
          }
      });
    };
  </script>

  <!-- Version number at the very bottom -->
  <div class="text-center text-gray-500 text-xs mt-8 pb-4">
    Version <span id="appVersion">1.1.4 TEST</span>
  </div>
</body>
</html>
